<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex" />
    <title>Calendrier Padel &amp; Inscriptions</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <header class="site-header">
      <h1>Padel – Tournois &amp; Inscriptions</h1>
      <p class="subtitle">Suivez les tournois TenUp, gérez vos équipes et accédez aux fiches officielles.</p>
    </header>

    <main>
      <section class="filters">
        <h2>Filtres</h2>
        <div class="filter-buttons" role="group" aria-label="Filtrer par catégorie">
          <button type="button" data-category="" class="filter-button active" aria-pressed="true">Tous</button>
          <button type="button" data-category="H" class="filter-button" aria-pressed="false">Hommes</button>
          <button type="button" data-category="MIXTE" class="filter-button" aria-pressed="false">Mixte</button>
          <button type="button" data-category="F" class="filter-button" aria-pressed="false">Dames</button>
        </div>

        <form id="filter-form" class="filter-form">
          <div class="filter-row">
            <label>
              Du
              <input type="date" name="from" required />
            </label>
            <label>
              Au
              <input type="date" name="to" required />
            </label>
          </div>
          <div class="filter-row">
            <label>
              Région
              <input type="text" name="region" placeholder="Ex. PACA" />
            </label>
            <label>
              Ville
              <input type="text" name="city" placeholder="Ex. Cagnes-sur-Mer" />
            </label>
            <label>
              Rayon (km)
              <input type="number" name="radius" min="0" step="1" />
            </label>
          </div>
          <fieldset class="level-fieldset">
            <legend>Niveau</legend>
            <div class="level-options">
              <label><input type="checkbox" name="level" value="P25" /> P25</label>
              <label><input type="checkbox" name="level" value="P100" /> P100</label>
              <label><input type="checkbox" name="level" value="P250" /> P250</label>
              <label><input type="checkbox" name="level" value="P500" /> P500</label>
              <label><input type="checkbox" name="level" value="P1000" /> P1000</label>
            </div>
          </fieldset>
          <div class="filter-actions">
            <button type="submit" class="primary">Appliquer</button>
            <button type="reset" class="secondary">Réinitialiser</button>
          </div>
        </form>
      </section>

      <section class="calendar" aria-label="Calendrier des tournois">
        <div class="calendar-header">
          <button type="button" class="calendar-nav" data-direction="prev" aria-label="Mois précédent">&#9664;</button>
          <h2 id="calendar-title">Calendrier</h2>
          <button type="button" class="calendar-nav" data-direction="next" aria-label="Mois suivant">&#9654;</button>
        </div>
        <table class="calendar-table" aria-describedby="calendar-title">
          <thead>
            <tr>
              <th scope="col">Lun</th>
              <th scope="col">Mar</th>
              <th scope="col">Mer</th>
              <th scope="col">Jeu</th>
              <th scope="col">Ven</th>
              <th scope="col">Sam</th>
              <th scope="col">Dim</th>
            </tr>
          </thead>
          <tbody id="calendar-body"></tbody>
        </table>
        <p class="calendar-legend">Les jours avec un point jaune contiennent au moins un tournoi.</p>
      </section>

      <section class="tournaments">
        <div class="list-header">
          <h2>Tournois</h2>
          <div class="list-actions">
            <span id="tournament-count" aria-live="polite">0 tournoi</span>
            <button type="button" id="admin-refresh" class="secondary" hidden>Rafraîchir (admin)</button>
          </div>
        </div>
        <p id="admin-status" class="admin-status muted" hidden></p>
        <div id="tournament-list" class="tournament-list" aria-live="polite"></div>
        <p id="empty-state" class="empty-state" hidden>Aucun tournoi ne correspond aux filtres sélectionnés.</p>
      </section>
    </main>

    <dialog id="registration-modal" aria-labelledby="modal-title">
      <form id="registration-form" method="post" novalidate>
        <header class="modal-header">
          <h2 id="modal-title">Inscription au tournoi</h2>
          <button type="button" class="close-button" aria-label="Fermer">&times;</button>
        </header>
        <div class="modal-body">
          <div class="tournament-summary">
            <p><strong id="modal-tournament-title"></strong></p>
            <p id="modal-tournament-date" class="muted"></p>
            <p id="modal-tournament-club" class="muted"></p>
          </div>

          <input type="hidden" name="tournament_id" id="input-tournament-id" required />
          <input type="hidden" name="tournament_title" id="input-tournament-title" required />
          <input type="hidden" name="tournament_date" id="input-tournament-date" required />
          <input type="hidden" name="tournament_url" id="input-tournament-url" required />
          <input type="hidden" name="club" id="input-club" required />
          <input type="hidden" name="sex" id="input-sex" required />
          <input type="hidden" name="category" id="input-category" required />

          <fieldset class="form-section">
            <legend>Joueur 1</legend>
            <label>
              Nom (optionnel)
              <input type="text" name="player1_name" autocomplete="name" />
            </label>
            <label>
              Licence*
              <input type="text" name="player1_licence" id="input-player1-licence" pattern="{{ licence_regex }}" required autocomplete="off" />
            </label>
            <label>
              Téléphone*
              <input type="tel" name="player1_phone" id="input-player1-phone" required autocomplete="tel" />
            </label>
            <label>
              Email
              <input type="email" name="player1_email" autocomplete="email" />
            </label>
          </fieldset>

          <fieldset class="form-section">
            <legend>Joueur 2</legend>
            <label>
              Nom (optionnel)
              <input type="text" name="player2_name" autocomplete="name" />
            </label>
            <label>
              Licence*
              <input type="text" name="player2_licence" id="input-player2-licence" pattern="{{ licence_regex }}" required autocomplete="off" />
            </label>
            <label>
              Téléphone
              <input type="tel" name="player2_phone" autocomplete="tel" />
            </label>
            <label>
              Email
              <input type="email" name="player2_email" autocomplete="email" />
            </label>
          </fieldset>

          <label class="notes-label">
            Notes (optionnel)
            <textarea name="notes" rows="2"></textarea>
          </label>

          <p class="rgpd">Les informations saisies sont utilisées uniquement pour gérer les inscriptions au tournoi.</p>
          <p class="form-feedback" id="form-feedback" role="alert" hidden></p>
        </div>
        <footer class="modal-footer">
          <button type="submit" id="submit-button">Envoyer l'inscription</button>
        </footer>
      </form>
    </dialog>

    <template id="tournament-card-template">
      <article class="tournament-card">
        <header>
          <span class="badge" data-role="category-badge"></span>
          <span class="badge status" data-role="status-badge"></span>
          <h3 data-role="title"></h3>
        </header>
        <p class="club" data-role="club"></p>
        <ul class="details">
          <li><span class="label">Dates</span> <span data-role="dates"></span></li>
          <li><span class="label">Lieu</span> <span data-role="location"></span></li>
          <li><span class="label">Niveau</span> <span data-role="level"></span></li>
        </ul>
        <div class="actions">
          <a data-role="tenup-link" target="_blank" rel="noopener" class="primary">S'inscrire sur TenUp</a>
          <a data-role="details-link" target="_blank" rel="noopener" class="secondary">Voir la fiche</a>
          <button type="button" class="secondary" data-role="register-button">Pré-inscrire</button>
        </div>
      </article>
    </template>

    <script>
      const LICENCE_REGEX = new RegExp({{ licence_regex|tojson }}, 'i');
      const MAX_TEAMS = {{ max_teams|default('null') }};
      const TENUP_DEFAULTS = {{ tenup_defaults|tojson }};
      const TENUP_MAX_RESULTS = TENUP_DEFAULTS.max_results || 500;
      const CATEGORY_LABELS = { H: 'Hommes', F: 'Dames', MIXTE: 'Mixte', '': 'Tous' };
      const CATEGORY_CLASSES = { H: 'sex-male', F: 'sex-female', MIXTE: 'sex-mixed' };
      const STATUS_LABELS = { true: 'Inscriptions ouvertes', false: 'Inscriptions fermées' };
      const STATUS_CLASSES = { true: 'status-open', false: 'status-closed', unknown: 'status-unknown' };

      const state = {
        tournaments: [],
        filters: createDefaultFilters(),
        calendarDate: new Date(),
        loading: false,
        error: null,
      };

      const listContainer = document.getElementById('tournament-list');
      const countLabel = document.getElementById('tournament-count');
      const emptyState = document.getElementById('empty-state');
      const calendarBody = document.getElementById('calendar-body');
      const calendarTitle = document.getElementById('calendar-title');
      const modal = document.getElementById('registration-modal');
      const form = document.getElementById('registration-form');
      const feedback = document.getElementById('form-feedback');
      const submitButton = document.getElementById('submit-button');
      const closeButton = modal.querySelector('.close-button');
      const filterForm = document.getElementById('filter-form');
      const adminRefreshButton = document.getElementById('admin-refresh');
      const adminStatus = document.getElementById('admin-status');

      init();

      function init() {
        applyFiltersToForm();
        setupEventListeners();
        updateAdminVisibility();
        loadTournaments();
      }

      function createDefaultFilters() {
        const today = new Date();
        const future = new Date(today.getTime());
        future.setDate(future.getDate() + 60);
        return {
          category: '',
          from: formatDateInput(today),
          to: formatDateInput(future),
          region: TENUP_DEFAULTS.region || '',
          city: TENUP_DEFAULTS.city || '',
          radius: TENUP_DEFAULTS.radius_km ?? '',
          levels: new Set(),
        };
      }

      function formatDateInput(date) {
        const tzOffset = date.getTimezoneOffset() * 60000;
        return new Date(date.getTime() - tzOffset).toISOString().slice(0, 10);
      }

      function applyFiltersToForm() {
        filterForm.elements.from.value = state.filters.from;
        filterForm.elements.to.value = state.filters.to;
        filterForm.elements.region.value = state.filters.region;
        filterForm.elements.city.value = state.filters.city;
        filterForm.elements.radius.value = state.filters.radius;
        const levelInputs = filterForm.querySelectorAll('input[name="level"]');
        levelInputs.forEach(input => {
          input.checked = state.filters.levels.has(input.value.toUpperCase());
        });
      }

      function setupEventListeners() {
        document.querySelectorAll('.filter-button').forEach(button => {
          button.addEventListener('click', () => {
            document.querySelectorAll('.filter-button').forEach(btn => {
              btn.classList.toggle('active', btn === button);
              btn.setAttribute('aria-pressed', btn === button ? 'true' : 'false');
            });
            state.filters.category = button.dataset.category || '';
            loadTournaments();
          });
        });

        filterForm.addEventListener('submit', event => {
          event.preventDefault();
          updateFiltersFromForm();
          loadTournaments();
        });

        filterForm.addEventListener('reset', event => {
          event.preventDefault();
          state.filters = createDefaultFilters();
          applyFiltersToForm();
          loadTournaments();
        });

        filterForm.querySelectorAll('input[name="level"]').forEach(input => {
          input.addEventListener('change', () => {
            const level = input.value.toUpperCase();
            if (input.checked) {
              state.filters.levels.add(level);
            } else {
              state.filters.levels.delete(level);
            }
          });
        });

        document.querySelectorAll('.calendar-nav').forEach(button => {
          button.addEventListener('click', () => {
            const direction = button.dataset.direction === 'next' ? 1 : -1;
            const nextDate = new Date(state.calendarDate.getTime());
            nextDate.setMonth(nextDate.getMonth() + direction);
            state.calendarDate = nextDate;
            renderCalendar();
          });
        });

        closeButton.addEventListener('click', () => closeModal());
        modal.addEventListener('cancel', event => {
          event.preventDefault();
          closeModal();
        });

        form.addEventListener('submit', handleRegistrationSubmit);

        if (adminRefreshButton) {
          adminRefreshButton.addEventListener('click', () => triggerAdminRefresh());
        }
      }

      function updateFiltersFromForm() {
        state.filters.from = filterForm.elements.from.value;
        state.filters.to = filterForm.elements.to.value;
        state.filters.region = filterForm.elements.region.value.trim();
        state.filters.city = filterForm.elements.city.value.trim();
        state.filters.radius = filterForm.elements.radius.value;
        const selectedLevels = new Set();
        filterForm.querySelectorAll('input[name="level"]:checked').forEach(input => {
          selectedLevels.add(input.value.toUpperCase());
        });
        state.filters.levels = selectedLevels;
      }

      function buildQueryParams() {
        const params = new URLSearchParams();
        if (state.filters.category) {
          params.set('category', state.filters.category);
        }
        if (state.filters.from) {
          params.set('from', state.filters.from);
        }
        if (state.filters.to) {
          params.set('to', state.filters.to);
        }
        if (state.filters.region) {
          params.set('region', state.filters.region);
        }
        if (state.filters.city) {
          params.set('city', state.filters.city);
        }
        if (state.filters.radius) {
          params.set('radius_km', state.filters.radius);
        }
        Array.from(state.filters.levels).forEach(level => params.append('level', level));
        params.set('limit', TENUP_MAX_RESULTS);
        params.set('sort', 'DATE_ASC');
        return params;
      }

      async function loadTournaments() {
        state.loading = true;
        state.error = null;
        renderList();
        const params = buildQueryParams();
        try {
          const response = await fetch(`/api/tournaments?${params.toString()}`);
          if (!response.ok) {
            throw new Error(`API error ${response.status}`);
          }
          const payload = await response.json();
          state.tournaments = (payload.items || []).map(normaliseTournament);
        } catch (error) {
          console.error(error);
          state.tournaments = [];
          state.error = "Impossible de charger les tournois TenUp.";
        } finally {
          state.loading = false;
          render();
        }
      }

      function normaliseTournament(raw) {
        const start = raw.start_date || raw.startDate || '';
        const end = raw.end_date || raw.endDate || start;
        const category = (raw.category || 'MIXTE').toUpperCase();
        const level = raw.level ? String(raw.level).toUpperCase() : null;
        const city = raw.city || '';
        const postalCode = raw.postal_code || '';
        const region = raw.region || '';
        const locationParts = [city, postalCode, region].filter(Boolean);
        const location = locationParts.join(' • ');
        return {
          ...raw,
          category,
          level,
          start_date: start,
          end_date: end,
          location,
          club_name: raw.club_name || '',
          sex: mapCategoryToSex(category),
          registration_url: raw.registration_url || raw.details_url,
          details_url: raw.details_url || raw.registration_url,
        };
      }

      function mapCategoryToSex(category) {
        if (category === 'H') return 'DM';
        if (category === 'F') return 'DD';
        return 'DX';
      }

      function render() {
        renderCalendar();
        renderList();
      }

      function renderCalendar() {
        const current = new Date(state.calendarDate.getTime());
        const year = current.getFullYear();
        const month = current.getMonth();
        const firstDay = new Date(year, month, 1);
        const startDay = (firstDay.getDay() + 6) % 7;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        calendarTitle.textContent = current.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
        calendarBody.innerHTML = '';

        let day = 1 - startDay;
        for (let week = 0; week < 6; week++) {
          const row = document.createElement('tr');
          for (let weekday = 0; weekday < 7; weekday++) {
            const cell = document.createElement('td');
            if (day < 1 || day > daysInMonth) {
              cell.classList.add('empty');
            } else {
              cell.textContent = day;
              const isoDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
              if (state.tournaments.some(t => t.start_date === isoDate)) {
                const marker = document.createElement('span');
                marker.className = 'calendar-marker';
                marker.title = 'Tournoi disponible';
                cell.appendChild(marker);
                cell.classList.add('has-tournament');
              }
            }
            row.appendChild(cell);
            day += 1;
          }
          calendarBody.appendChild(row);
          if (day > daysInMonth) {
            break;
          }
        }
      }

      function renderList() {
        listContainer.innerHTML = '';
        if (state.loading) {
          countLabel.textContent = 'Chargement…';
          emptyState.hidden = true;
          listContainer.setAttribute('aria-busy', 'true');
          return;
        }
        listContainer.removeAttribute('aria-busy');

        if (state.error) {
          countLabel.textContent = 'Erreur';
          emptyState.hidden = false;
          emptyState.textContent = state.error;
          return;
        }

        if (state.tournaments.length === 0) {
          countLabel.textContent = '0 tournoi';
          emptyState.hidden = false;
          emptyState.textContent = 'Aucun tournoi ne correspond aux filtres sélectionnés.';
          return;
        }

        emptyState.hidden = true;
        const sorted = [...state.tournaments].sort((a, b) => {
          if (a.start_date && b.start_date) {
            return a.start_date.localeCompare(b.start_date);
          }
          return a.title.localeCompare(b.title);
        });

        countLabel.textContent = `${sorted.length} ${sorted.length > 1 ? 'tournois' : 'tournoi'}`;
        const template = document.getElementById('tournament-card-template');

        sorted.forEach(tournament => {
          const fragment = template.content.cloneNode(true);
          const categoryBadge = fragment.querySelector('[data-role="category-badge"]');
          const statusBadge = fragment.querySelector('[data-role="status-badge"]');
          const title = fragment.querySelector('[data-role="title"]');
          const club = fragment.querySelector('[data-role="club"]');
          const dates = fragment.querySelector('[data-role="dates"]');
          const location = fragment.querySelector('[data-role="location"]');
          const level = fragment.querySelector('[data-role="level"]');
          const tenupLink = fragment.querySelector('[data-role="tenup-link"]');
          const detailsLink = fragment.querySelector('[data-role="details-link"]');
          const registerButton = fragment.querySelector('[data-role="register-button"]');

          const categoryClass = CATEGORY_CLASSES[tournament.category] || CATEGORY_CLASSES.MIXTE;
          categoryBadge.textContent = CATEGORY_LABELS[tournament.category] || 'Mixte';
          categoryBadge.classList.add(categoryClass);

          if (tournament.inscriptions_open === null || typeof tournament.inscriptions_open === 'undefined') {
            statusBadge.textContent = 'Inscriptions à confirmer';
            statusBadge.classList.add('status-unknown');
          } else {
            const key = tournament.inscriptions_open ? 'true' : 'false';
            statusBadge.textContent = STATUS_LABELS[key];
            statusBadge.classList.add(STATUS_CLASSES[key]);
          }

          title.textContent = tournament.title;
          club.textContent = tournament.club_name || tournament.location || 'Club à confirmer';
          dates.textContent = formatDateRange(tournament.start_date, tournament.end_date);
          location.textContent = tournament.location || 'Lieu à confirmer';
          level.textContent = tournament.level || 'Tous niveaux';

          if (tournament.registration_url) {
            tenupLink.href = tournament.registration_url;
            tenupLink.classList.remove('disabled');
          } else {
            tenupLink.href = '#';
            tenupLink.classList.add('disabled');
          }
          const detailUrl = tournament.details_url || tournament.registration_url;
          if (detailUrl) {
            detailsLink.href = detailUrl;
            detailsLink.classList.remove('disabled');
          } else {
            detailsLink.href = '#';
            detailsLink.classList.add('disabled');
          }

          registerButton.addEventListener('click', () => openModal(tournament));

          listContainer.appendChild(fragment);
        });
      }

      function formatDateRange(start, end) {
        if (!start) {
          return 'Dates à confirmer';
        }
        const startDate = new Date(start);
        if (Number.isNaN(startDate.getTime())) {
          return 'Dates à confirmer';
        }
        const endDate = end ? new Date(end) : startDate;
        const formatterStart = new Intl.DateTimeFormat('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
        const formatterEndSame = new Intl.DateTimeFormat('fr-FR', { day: 'numeric', month: 'short' });
        const formatterEndFull = new Intl.DateTimeFormat('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
        const startLabel = formatterStart.format(startDate);
        if (!end || Number.isNaN(endDate.getTime()) || startDate.getTime() === endDate.getTime()) {
          return startLabel;
        }
        const sameMonthYear = startDate.getMonth() === endDate.getMonth() && startDate.getFullYear() === endDate.getFullYear();
        const endLabel = (sameMonthYear ? formatterEndSame : formatterEndFull).format(endDate);
        return `${startLabel} → ${endLabel}`;
      }

      function openModal(tournament) {
        form.reset();
        feedback.hidden = true;
        submitButton.disabled = false;
        submitButton.textContent = "Envoyer l'inscription";

        document.getElementById('modal-tournament-title').textContent = tournament.title;
        document.getElementById('modal-tournament-date').textContent = formatDateRange(tournament.start_date, tournament.end_date);
        const clubSummary = [tournament.club_name, tournament.location].filter(Boolean).join(' • ');
        document.getElementById('modal-tournament-club').textContent = clubSummary;

        document.getElementById('input-tournament-id').value = tournament.external_id || tournament.id || '';
        document.getElementById('input-tournament-title').value = tournament.title;
        document.getElementById('input-tournament-date').value = tournament.start_date;
        document.getElementById('input-tournament-url').value = tournament.details_url || tournament.registration_url || '';
        document.getElementById('input-club').value = tournament.club_name || tournament.location || '';
        document.getElementById('input-sex').value = tournament.sex || '';
        document.getElementById('input-category').value = tournament.level || '';

        if (typeof MAX_TEAMS === 'number') {
          feedback.hidden = false;
          feedback.textContent = `Nombre maximum d'équipes : ${MAX_TEAMS}. Au-delà, inscription sur liste d'attente.`;
        }

        if (typeof modal.showModal === 'function') {
          modal.showModal();
        } else {
          modal.setAttribute('open', 'open');
        }
      }

      function closeModal() {
        if (typeof modal.close === 'function' && modal.open) {
          modal.close();
        } else {
          modal.removeAttribute('open');
        }
      }

      function setFeedback(message, isError = false) {
        feedback.hidden = false;
        feedback.textContent = message;
        feedback.classList.toggle('error', isError);
      }

      async function handleRegistrationSubmit(event) {
        event.preventDefault();
        feedback.classList.remove('error');

        const licence1 = document.getElementById('input-player1-licence').value.trim();
        const licence2 = document.getElementById('input-player2-licence').value.trim();
        const phone1 = document.getElementById('input-player1-phone').value.trim();

        if (!LICENCE_REGEX.test(licence1) || !LICENCE_REGEX.test(licence2)) {
          setFeedback('Merci de renseigner des licences valides.', true);
          return;
        }
        if (licence1.toUpperCase() === licence2.toUpperCase()) {
          setFeedback('Les deux licences doivent être différentes.', true);
          return;
        }
        if (!phone1) {
          setFeedback('Merci de renseigner un numéro de téléphone pour le joueur 1.', true);
          return;
        }

        submitButton.disabled = true;
        submitButton.textContent = 'Envoi en cours…';

        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());

        try {
          const response = await fetch('/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const result = await response.json();
          if (!response.ok || !result.ok) {
            setFeedback(result.message || "Une erreur est survenue.", true);
            submitButton.disabled = false;
            submitButton.textContent = 'Réessayer';
            return;
          }
          setFeedback(result.message || 'Inscription enregistrée.');
          submitButton.textContent = 'Envoyé !';
          setTimeout(() => {
            setFeedback(result.message || 'Inscription enregistrée.');
            closeModal();
          }, 1500);
        } catch (error) {
          console.error(error);
          setFeedback("Impossible d'envoyer le formulaire.", true);
          submitButton.disabled = false;
          submitButton.textContent = 'Réessayer';
        }
      }

      function updateAdminVisibility() {
        const params = new URLSearchParams(window.location.search);
        const isAdmin = params.get('admin') === '1';
        if (isAdmin) {
          adminRefreshButton.hidden = false;
        }
      }

      async function triggerAdminRefresh() {
        const token = window.prompt('Token administrateur TenUp');
        if (!token) {
          return;
        }
        adminRefreshButton.disabled = true;
        adminRefreshButton.textContent = 'Rafraîchissement…';
        adminStatus.hidden = false;
        adminStatus.textContent = 'Scraping en cours…';
        try {
          const payload = {
            categories: state.filters.category ? [state.filters.category] : ['H', 'F', 'MIXTE'],
            date_from: state.filters.from,
            date_to: state.filters.to,
            region: state.filters.region,
            city: state.filters.city,
            radius_km: state.filters.radius ? Number(state.filters.radius) : undefined,
            level: Array.from(state.filters.levels),
            limit: TENUP_MAX_RESULTS,
          };
          const response = await fetch('/admin/scrape', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-ADMIN-TOKEN': token,
            },
            body: JSON.stringify(payload),
          });
          const result = await response.json();
          if (!response.ok || !result.ok) {
            throw new Error(result.message || 'Échec du scraping');
          }
          adminStatus.textContent = `Scraping terminé : ${result.inserted} nouveaux tournois, ${result.updated} mis à jour.`;
          loadTournaments();
        } catch (error) {
          console.error(error);
          adminStatus.textContent = error.message || 'Impossible de lancer le scraping.';
        } finally {
          adminRefreshButton.disabled = false;
          adminRefreshButton.textContent = 'Rafraîchir (admin)';
        }
      }
    </script>
  </body>
</html>
